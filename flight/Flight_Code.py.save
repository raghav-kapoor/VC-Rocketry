#!/usr/bin/env python

import sys
import time
from Subfact_ina219 import INA219
from envirophat import weather, motion
import gps
from gps import *
from subprocess import call
import RPi.GPIO as GPIO

ina219A = INA219(0x45)
ina219B = INA219(0x41)

resultA = ina219A.getBusVoltage_V()
resultB = ina219B.getBusVoltage_V()
call(["sudo", "systemctl", "stop", "gpsd.socket"])
call(["sudo", "systemctl", "disable", "gpsd.socket"])
call(["sudo", "gpsd", "/dev/ttyS0", "-F", "/var/run/gpsd.sock"])

def write(line):
    sys.stdout.write(line)
    sys.stdout.flush()

write("--- Enviro pHAT Monitoring ---")

try:
    while True:
        output = """
Temp: {t}c
Pressure: {p}hPa
Acceleration_x:{a_x}
Acceleration_y:{a_y}
Acceleration_z:{a_z}
Shunt_0x45:{shunt1}mV
Bus_0x45:{bus1}V
Current_0x45:{current1}mA
Shunt_0x41:{shunt2}mV
Bus_0x41:{bus2}V
Current_0x41:{current2}mA
Latitude:{latitude}
Longitude:{longitude}
Altitude:{altitude}
Speed:{speed}

""".format(
        t = round(weather.temperature(),2),
        p = round(weather.pressure(),2),
	a_x = motion.accelerometer().x,
	a_y = motion.accelerometer().y,
	a_z = motion.accelerometer().z,
	shunt1 = ina219A.getShuntVoltage_mV(),
	bus1 = ina219A.getBusVoltage_V(),
	current1 = ina219A.getCurrent_mA(),
	shunt2 = ina219B.getShuntVoltage_mV(),
	bus2 = ina219B.getBusVoltage_V(),
	current2 = ina219B.getCurrent_mA(),
	latitude = gpsd.fix.latitude,
	longitude = gpsd.fix.longitude,
	speed = gpsd.fix.speed,
	altitude = gpsd.fix.altitude
    )
        output = output.replace("\n","\n\033[K")
        write(output)
        lines = len(output.split("\n"))
        write("\033[{}A".format(lines - 1))

        time.sleep(1)

except KeyboardInterrupt:
    pass
